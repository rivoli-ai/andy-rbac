@page "/applications"

<PageTitle>Applications - Andy RBAC</PageTitle>

<div class="page-header">
    <div class="page-header-actions">
        <div>
            <h1>Applications</h1>
            <p class="subtitle">Manage registered applications and their permissions</p>
        </div>
        <button class="btn btn-primary" @onclick="ShowCreateModal">
            + New Application
        </button>
    </div>
</div>

<div class="card mb-3">
    <div class="d-flex align-center gap-2">
        <div class="search-box" style="flex: 1;">
            <input type="text" class="form-control" placeholder="Search applications..." @bind="_searchTerm" @bind:event="oninput" />
        </div>
    </div>
</div>

<div class="table-container">
    @if (_loading)
    {
        <div class="loading">
            <div class="spinner"></div>
        </div>
    }
    else if (FilteredApplications.Count == 0)
    {
        <div class="empty-state">
            <div class="empty-state-title">No applications found</div>
            <p class="empty-state-text">Create your first application to get started.</p>
            <button class="btn btn-primary" @onclick="ShowCreateModal">Create Application</button>
        </div>
    }
    else
    {
        <table class="table">
            <thead>
                <tr>
                    <th>Code</th>
                    <th>Name</th>
                    <th>Resource Types</th>
                    <th>Roles</th>
                    <th>Created</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var app in FilteredApplications)
                {
                    <tr>
                        <td><code>@app.Code</code></td>
                        <td>@app.Name</td>
                        <td>@app.ResourceTypeCount</td>
                        <td>@app.RoleCount</td>
                        <td class="text-muted">@app.CreatedAt.ToString("d")</td>
                        <td>
                            <button class="btn btn-secondary btn-sm" @onclick="() => ViewApplication(app)">View</button>
                            <button class="btn btn-danger btn-sm" @onclick="() => DeleteApplication(app)">Delete</button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }
</div>

@if (_showCreateModal)
{
    <div class="modal-overlay" @onclick="CloseModal">
        <div class="modal" @onclick:stopPropagation>
            <div class="modal-header">
                <h3 class="modal-title">Create Application</h3>
                <button class="btn btn-icon" @onclick="CloseModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label required">Code</label>
                    <input type="text" class="form-control" @bind="_newApp.Code" placeholder="my-app" />
                    <p class="form-text">Unique identifier for the application (lowercase, hyphens allowed)</p>
                </div>
                <div class="form-group">
                    <label class="form-label required">Name</label>
                    <input type="text" class="form-control" @bind="_newApp.Name" placeholder="My Application" />
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea class="form-control" @bind="_newApp.Description" rows="3" placeholder="Optional description"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" @onclick="CloseModal">Cancel</button>
                <button class="btn btn-primary" @onclick="CreateApplication">Create</button>
            </div>
        </div>
    </div>
}

@code {
    private bool _loading = true;
    private string _searchTerm = "";
    private List<ApplicationDto> _applications = new();
    private bool _showCreateModal = false;
    private CreateApplicationModel _newApp = new();

    private List<ApplicationDto> FilteredApplications => string.IsNullOrWhiteSpace(_searchTerm)
        ? _applications
        : _applications.Where(a =>
            a.Code.Contains(_searchTerm, StringComparison.OrdinalIgnoreCase) ||
            a.Name.Contains(_searchTerm, StringComparison.OrdinalIgnoreCase)).ToList();

    protected override async Task OnInitializedAsync()
    {
        await LoadApplications();
    }

    private async Task LoadApplications()
    {
        _loading = true;
        try
        {
            // TODO: Load from API
            _applications = new List<ApplicationDto>
            {
                new() { Id = Guid.NewGuid(), Code = "andy-docs", Name = "Andy Docs", ResourceTypeCount = 3, RoleCount = 4, CreatedAt = DateTimeOffset.UtcNow.AddDays(-30) },
                new() { Id = Guid.NewGuid(), Code = "andy-auth", Name = "Andy Auth", ResourceTypeCount = 2, RoleCount = 3, CreatedAt = DateTimeOffset.UtcNow.AddDays(-60) },
                new() { Id = Guid.NewGuid(), Code = "andy-portal", Name = "Andy Portal", ResourceTypeCount = 5, RoleCount = 6, CreatedAt = DateTimeOffset.UtcNow.AddDays(-15) },
            };
        }
        finally
        {
            _loading = false;
        }
        await Task.CompletedTask;
    }

    private void ShowCreateModal()
    {
        _newApp = new CreateApplicationModel();
        _showCreateModal = true;
    }

    private void CloseModal()
    {
        _showCreateModal = false;
    }

    private async Task CreateApplication()
    {
        // TODO: Call API
        _applications.Add(new ApplicationDto
        {
            Id = Guid.NewGuid(),
            Code = _newApp.Code,
            Name = _newApp.Name,
            ResourceTypeCount = 0,
            RoleCount = 0,
            CreatedAt = DateTimeOffset.UtcNow
        });
        CloseModal();
        await Task.CompletedTask;
    }

    private void ViewApplication(ApplicationDto app)
    {
        // TODO: Navigate to detail page
    }

    private async Task DeleteApplication(ApplicationDto app)
    {
        // TODO: Confirm and delete
        _applications.Remove(app);
        await Task.CompletedTask;
    }

    private class ApplicationDto
    {
        public Guid Id { get; set; }
        public string Code { get; set; } = "";
        public string Name { get; set; } = "";
        public int ResourceTypeCount { get; set; }
        public int RoleCount { get; set; }
        public DateTimeOffset CreatedAt { get; set; }
    }

    private class CreateApplicationModel
    {
        public string Code { get; set; } = "";
        public string Name { get; set; } = "";
        public string? Description { get; set; }
    }
}
